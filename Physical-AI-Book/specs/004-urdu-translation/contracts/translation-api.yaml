openapi: 3.0.3
info:
  title: Urdu Translation API
  description: |
    API for translating textbook chapters to Urdu on-demand.

    **Features**:
    - On-demand translation of individual chapters
    - Authenticated access only
    - Caching to minimize translation costs
    - Usage analytics tracking

    **Constitution Compliance**:
    - ✅ Principle XXI: Authentication required for all translation endpoints
    - ✅ Principle XXII: Original English files never modified
    - ✅ Principle XIX: Technical terms preserved in English
    - ✅ Principle XX: Simple, readable Urdu output
  version: 1.0.0
  contact:
    name: Physical AI Book Team
  license:
    name: CC BY-NC-SA 4.0

servers:
  - url: http://localhost:8000
    description: Local development
  - url: https://api.physicalaibook.com
    description: Production

tags:
  - name: translation
    description: Chapter translation operations
  - name: analytics
    description: Translation usage tracking

paths:
  /api/translate:
    post:
      summary: Translate chapter to Urdu
      description: |
        Translate a textbook chapter from English to Urdu.

        **Flow**:
        1. Validate user authentication (JWT token)
        2. Check cache for existing translation
        3. If cache miss, translate via OpenAI Agents SDK
        4. Store translation in cache
        5. Log translation request
        6. Return translated content

        **Performance**:
        - Cache hit: < 100ms
        - Cache miss: 2-30 seconds (depending on chapter length)
      operationId: translateChapter
      tags:
        - translation
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TranslateRequest'
            examples:
              basicRequest:
                summary: Basic translation request
                value:
                  chapter_slug: "01-what-is-ros2"
              withTargetLanguage:
                summary: Request with explicit target language
                value:
                  chapter_slug: "03-llms-for-cognitive-planning"
                  target_language: "ur"
      responses:
        '200':
          description: Translation successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TranslateResponse'
              examples:
                success:
                  summary: Successful translation
                  value:
                    status: "success"
                    translated_content: "# ROS 2 کیا ہے؟\n\nROS 2 روبوٹ سافٹ ویئر لکھنے کے لیے ایک لچکدار فریم ورک ہے..."
                    from_cache: false
                    cached_at: null
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidSlug:
                  summary: Invalid chapter slug
                  value:
                    status: "error"
                    message: "Invalid chapter_slug format. Expected format: '01-chapter-name'"
                chapterNotFound:
                  summary: Chapter not found
                  value:
                    status: "error"
                    message: "Chapter not found: nonexistent-chapter"
        '401':
          description: Unauthorized - authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                noToken:
                  summary: No authentication token provided
                  value:
                    status: "error"
                    message: "Authentication required. Please log in to use Urdu translation."
                invalidToken:
                  summary: Invalid or expired token
                  value:
                    status: "error"
                    message: "Invalid or expired authentication token."
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                rateLimitGlobal:
                  summary: Global rate limit
                  value:
                    status: "error"
                    message: "Translation service is busy. Please try again in a moment."
                    retry_after: 60
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                translationFailed:
                  summary: OpenAI API error
                  value:
                    status: "error"
                    message: "Translation failed. Please try again."

  /api/translate/log:
    post:
      summary: Log translation action
      description: |
        Track user translation actions for analytics.

        **Actions**:
        - `translate_requested`: User clicked "Translate to Urdu"
        - `toggle_to_english`: User toggled back to English
        - `toggle_to_urdu`: User toggled back to Urdu
        - `translation_failed`: Translation request failed
      operationId: logTranslationAction
      tags:
        - analytics
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LogActionRequest'
            examples:
              translateRequested:
                summary: Translation requested
                value:
                  chapter_slug: "01-what-is-ros2"
                  action: "translate_requested"
              toggleToEnglish:
                summary: Toggled to English
                value:
                  chapter_slug: "01-what-is-ros2"
                  action: "toggle_to_english"
      responses:
        '200':
          description: Action logged successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogActionResponse'
              examples:
                success:
                  summary: Logged successfully
                  value:
                    logged: true
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/translate/cache/{chapter_slug}:
    delete:
      summary: Invalidate cached translation (admin only)
      description: |
        Manually invalidate cached translation for a specific chapter.
        Useful when chapter content is updated and cache needs immediate refresh.
      operationId: invalidateCache
      tags:
        - translation
      security:
        - bearerAuth: []
      parameters:
        - name: chapter_slug
          in: path
          required: true
          description: Chapter slug to invalidate
          schema:
            type: string
            example: "01-what-is-ros2"
        - name: language
          in: query
          required: false
          description: Language code (defaults to all languages)
          schema:
            type: string
            enum: [ur, en]
            default: ur
      responses:
        '200':
          description: Cache invalidated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  message:
                    type: string
                    example: "Cache invalidated for chapter: 01-what-is-ros2"
                  invalidated_count:
                    type: integer
                    description: Number of cache entries deleted
                    example: 1
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - admin access required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT token from Better-Auth authentication system.

        **How to obtain**:
        1. Sign in via `/api/auth/signin`
        2. Extract JWT from session cookie or response
        3. Include in Authorization header: `Bearer <token>`

  schemas:
    TranslateRequest:
      type: object
      required:
        - chapter_slug
      properties:
        chapter_slug:
          type: string
          description: Unique identifier for the chapter (e.g., "01-what-is-ros2")
          example: "01-what-is-ros2"
          pattern: '^[0-9]{2}-[a-z0-9-]+$'
        target_language:
          type: string
          description: Target language code (currently only Urdu supported)
          enum: [ur]
          default: ur
          example: "ur"

    TranslateResponse:
      type: object
      required:
        - status
        - translated_content
      properties:
        status:
          type: string
          enum: [success, error]
          example: "success"
        translated_content:
          type: string
          description: Full markdown content translated to Urdu
          example: "# ROS 2 کیا ہے؟\n\nROS 2 روبوٹ سافٹ ویئر لکھنے کے لیے ایک لچکدار فریم ورک ہے..."
        from_cache:
          type: boolean
          description: Whether translation was served from cache
          example: false
        cached_at:
          type: string
          format: date-time
          nullable: true
          description: When translation was originally cached (null if not from cache)
          example: "2025-12-20T10:30:00Z"
        message:
          type: string
          description: Additional information (optional)
          example: "Translation generated successfully"

    LogActionRequest:
      type: object
      required:
        - chapter_slug
        - action
      properties:
        chapter_slug:
          type: string
          description: Chapter identifier
          example: "01-what-is-ros2"
          pattern: '^[0-9]{2}-[a-z0-9-]+$'
        action:
          type: string
          description: Action type
          enum:
            - translate_requested
            - toggle_to_english
            - toggle_to_urdu
            - translation_failed
          example: "translate_requested"

    LogActionResponse:
      type: object
      required:
        - logged
      properties:
        logged:
          type: boolean
          description: Whether action was successfully logged
          example: true

    ErrorResponse:
      type: object
      required:
        - status
        - message
      properties:
        status:
          type: string
          enum: [error]
          example: "error"
        message:
          type: string
          description: Human-readable error message
          example: "Authentication required. Please log in to use Urdu translation."
        retry_after:
          type: integer
          description: Seconds to wait before retrying (for rate limits)
          nullable: true
          example: 60
